# 회원 기능 테스트

# 회원 가입 기능 test

---

```java
~~@RunWith(SpringRunner.class)~~ // JUnit5부터는 안써도 됨!
@SpringBootTest
@Transactional
public class MemberServiceTest {

    @Autowired MemberService memberService;
    @Autowired MemberRepository memberRepository;

    @Test
    public void 회원가입() throws Exception {
        //given
        Member member = new Member();
        member.setName("kim");

        //when
        Long saveId = memberService.join(member);

        //then
        assertThat(memberRepository.findOne(saveId)).isEqualTo(member);
    }
}
```

## 로그에서 Insert into를 볼 수 없다면

---

- 이유는 간단 : 롤백이 되기 때문.

## Insert into 보는 법

---

1. 테스트 메서드에 `@Rollback(false)`
    - 이러면 DB에서도 테스트용 멤버 확인 가능
2. assertThat 테스트 결과 직전 `em.flush();`
    
    ```java
    ~~@RunWith(SpringRunner.class)~~ // JUnit5부터는 안써도 됨!
    @SpringBootTest
    @Transactional
    public class MemberServiceTest {
    
        @Autowired MemberService memberService;
        @Autowired MemberRepository memberRepository;
        @Autowired EntityManager em;
    
        @Test
        public void 회원가입() throws Exception {
            //given
            Member member = new Member();
            member.setName("kim");
    
            //when
            Long saveId = memberService.join(member);
    
            //then
            em.flush();
            assertThat(memberRepository.findOne(saveId)).isEqualTo(member);
        }
    }
    ```
    
    - flush가 영속성 컨텍스트에 있는 변경 및 등록 내용을 데이터베이스에 반영하는 것이므로 인서트 쿼리 확인 가능.
    - 이후 롤백되므로 DB에서 테스트용 멤버는 없음.

# 중복 회원 예외 기능 test

---

## try-catch 문

---

```java
    @Test
    public void 중복_회원_예외() throws Exception {
        //given
        Member member1 = new Member();
        member1.setName("kim");

        Member member2 = new Member();
        member2.setName("kim");

        //when
        memberService.join(member1);
        try {
            memberService.join(member2); //예외가 발생해야 한다!!!
        } catch (IllegalStateException e) {
            return;
        }
        //then
        fail("예외가 발생해야 한다.");
    }
```

- 만약 예외가 발생하지 않고, assertj 라이브러리의 fail() 문 까지 내려오면 fail()이 테스트를 실패시키게 설계

## `@Test(expected = IllegalStateException.class)`

---

```java
    @Test(expected = IllegalStateException.class)
    public void 중복_회원_예외() throws Exception {
        //given
        Member member1 = new Member();
        member1.setName("kim");

        Member member2 = new Member();
        member2.setName("kim");

        //when
        memberService.join(member1);
        memberService.join(member2); //예외가 발생해야 한다!!!
        
        //then
        fail("예외가 발생해야 한다.");
    }
```

- `IllegalStateException` 해당 테스트는 이란 예외가 예상된단 뜻.
- try-catch 문 없이 간결하게 작성 가능

# 테스트에서 메모리 모드 DB 쓰는 법

---

- test 경로 밑에 resources 패키지 추가 후 yml 설정파일 복붙
    
    ![image.png](%E1%84%92%E1%85%AC%E1%84%8B%E1%85%AF%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%20%E1%84%90%E1%85%A6%E1%84%89%E1%85%B3%E1%84%90%E1%85%B3%2013fd916bc5a8805a9974e15fc3034f28/image.png)
    
    - 이러면 src 경로의 yml이 아니라 test 경로의 yml로 동작을 하게 된다.
- 이후 h2 사이트의 Cheat Sheet에 있는 내용처럼

![image.png](%E1%84%92%E1%85%AC%E1%84%8B%E1%85%AF%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%20%E1%84%90%E1%85%A6%E1%84%89%E1%85%B3%E1%84%90%E1%85%B3%2013fd916bc5a8805a9974e15fc3034f28/image%201.png)

![image.png](%E1%84%92%E1%85%AC%E1%84%8B%E1%85%AF%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%20%E1%84%90%E1%85%A6%E1%84%89%E1%85%B3%E1%84%90%E1%85%B3%2013fd916bc5a8805a9974e15fc3034f28/image%202.png)

![image.png](%E1%84%92%E1%85%AC%E1%84%8B%E1%85%AF%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%20%E1%84%90%E1%85%A6%E1%84%89%E1%85%B3%E1%84%90%E1%85%B3%2013fd916bc5a8805a9974e15fc3034f28/image%203.png)

- url을 바꿔주면 완료

---

- 근데 사실 default가 메모리 모드이므로 **datasource의 설정이** **아예 비어있어도 메모리모드 테스트 검증이 가능!**
    - datasource는 메모리 모드가 default
    - ddl-auto는 create-drop이 default
        
        ![image.png](%E1%84%92%E1%85%AC%E1%84%8B%E1%85%AF%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%20%E1%84%90%E1%85%A6%E1%84%89%E1%85%B3%E1%84%90%E1%85%B3%2013fd916bc5a8805a9974e15fc3034f28/image%204.png)