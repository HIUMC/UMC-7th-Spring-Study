# 주문 검색 기능 개발

- JPA에서 동적 쿼리를 어떻게 해결해야 하는가?

![image.png](%E1%84%8C%E1%85%AE%E1%84%86%E1%85%AE%E1%86%AB%20%E1%84%80%E1%85%A5%E1%86%B7%E1%84%89%E1%85%A2%E1%86%A8%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%20%E1%84%80%E1%85%A2%E1%84%87%E1%85%A1%E1%86%AF%20141d916bc5a880d3807dddfe7aac1a2d/image.png)

# 검색 조건 파라미터 만들기

---

- OrderSearch 클래스를 작성해준다.

```java
package jpabook.jpashop.repository;

import jpabook.jpashop.domain.OrderStatus;
import lombok.Getter;
import lombok.Setter;

@Getter @Setter
public class OrderSearch {

    private String memberName; //회원 이름
    private OrderStatus orderStatus; //주문 상태[ORDER, CANCEL]
}
```

# 동적 쿼리 1) JPQL로 처리

---

```java
@Repository
@RequiredArgsConstructor
public class OrderRepository {

    ...

    public List<Order> findAll(OrderSearch orderSearch) {

        return em.createQuery("select o from Order o join o.member m" +
                        " where o.status = :status" +
                        " and m.name like :name", Order.class)
                .setParameter("status", orderSearch.getOrderStatus())
                .setParameter("name", orderSearch.getMemberName())
//                .setFirstResult(100) //페이징 - 100부터 시작해서 + 뒷줄(1000개 갖고오겠음)
                .setMaxResults(1000) //최대 1000건
                .getResultList();
    }
}
```

- 위처럼 간단하지 않다.

- 검색 조건(`OrderStatus`, `MemberName`)에 따라 조건을 동적으로 추가
- `isFirstCondition` 플래그를 통해 `where`와 `and`를 적절히 추가

```java
@Repository
@RequiredArgsConstructor
public class OrderRepository {

    ...

    public List<Order> findAll(OrderSearch orderSearch) {

        String jpql = "select o from Order o join o.member m";
        boolean isFirstCondition = true;

        //주문 상태 검색
        if (orderSearch.getOrderStatus() != null) {
            if (isFirstCondition) {
                jpql += " where";
                isFirstCondition = false;
            } else {
                jpql += " and";
            }
            jpql += " o.status = :status";
        }
        //회원 이름 검색
        if (StringUtils.hasText(orderSearch.getMemberName())) {
            if (isFirstCondition) {
                jpql += " where";
                isFirstCondition = false;
            } else {
                jpql += " and";
            }
            jpql += " m.name like :name";
        }

        return em.createQuery(jpql, Order.class)
                .setMaxResults(1000) //최대 1000건
                .getResultList();
    }
}
```

- 이걸로 끝인가? **NO**

- 패러미터 바인딩도 동적으로 처리돼야 함.

```java
@Repository
@RequiredArgsConstructor
public class OrderRepository {

    ...

    public List<Order> findAll(OrderSearch orderSearch) {

        String jpql = "select o from Order o join o.member m";
        boolean isFirstCondition = true;

        //주문 상태 검색
        if (orderSearch.getOrderStatus() != null) {
            if (isFirstCondition) {
                jpql += " where";
                isFirstCondition = false;
            } else {
                jpql += " and";
            }
            jpql += " o.status = :status";
        }
        //회원 이름 검색
        if (StringUtils.hasText(orderSearch.getMemberName())) {
            if (isFirstCondition) {
                jpql += " where";
                isFirstCondition = false;
            } else {
                jpql += " and";
            }
            jpql += " m.name like :name";
        }

        TypedQuery<Order> query = em.createQuery(jpql, Order.class)
                .setMaxResults(1000);

        if (orderSearch.getOrderStatus() != null) {
            query = query.setParameter("status", orderSearch.getOrderStatus());
        }
        if (StringUtils.hasText(orderSearch.getMemberName())) {
            query = query.setParameter("name", orderSearch.getMemberName());
        }
        return query.getResultList();
    }
}
```

# 동적 쿼리 2) JPA Criteria로 처리

---

- 총평 : 실무에서 쓰라고 만든게 아님.
    
    ```java
        public List<Order> findAllByCriteria(OrderSearch orderSearch) {
    
            CriteriaBuilder cb = em.getCriteriaBuilder();
            CriteriaQuery<Order> cq = cb.createQuery(Order.class);
            Root<Order> o = cq.from(Order.class);
            Join<Order, Member> m = o.join("member", JoinType.INNER); //회원과 조인
    
            List<Predicate> criteria = new ArrayList<>();
    
            //주문 상태 검색
            if (orderSearch.getOrderStatus() != null) {
                Predicate status = cb.equal(o.get("status"), orderSearch.getOrderStatus());
                criteria.add(status);
            }
            //회원 이름 검색
            if (StringUtils.hasText(orderSearch.getMemberName())) {
                Predicate name =
                        cb.like(m.<String>get("name"), "%" + orderSearch.getMemberName() + "%");
                criteria.add(name);
            }
    
            cq.where(cb.and(criteria.toArray(new Predicate[criteria.size()])));
            TypedQuery<Order> query = em.createQuery(cq).setMaxResults(1000); //최대 1000건
            return query.getResultList();
        }
    ```
    

# 동적 쿼리 3) QueryDSL로 처리

---

```java
    public List<Order> findAllByCriteria(OrderSearch orderSearch) {
			QOrder order = QOrder.order;
			QMember member = QMember.member;
			
			return query
							.select(order)
							.from(order)
							.join(order.member, member)
							.where(statusEq(orderSearch.getOrderStatus()),
											nameLike(orderSearch.getMemberName()))
							.limit(1000)
							.fetch();
    }
    
    private BooleanExpression statusEq(OrderStatus statusCond) {
	    if (statusCond == null) {
		    return null;
	    }
	    return order.status.eq(statusCond);
    }
    
    private BooleanExpression nameLike(String nameCond) {
	    if (!StringUtils.hasText(nameCond)) {
		    return null;
	    }
	    return member.name.like(nameCond);
    }
```

![image.png](%E1%84%8C%E1%85%AE%E1%84%86%E1%85%AE%E1%86%AB%20%E1%84%80%E1%85%A5%E1%86%B7%E1%84%89%E1%85%A2%E1%86%A8%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%20%E1%84%80%E1%85%A2%E1%84%87%E1%85%A1%E1%86%AF%20141d916bc5a880d3807dddfe7aac1a2d/image%201.png)