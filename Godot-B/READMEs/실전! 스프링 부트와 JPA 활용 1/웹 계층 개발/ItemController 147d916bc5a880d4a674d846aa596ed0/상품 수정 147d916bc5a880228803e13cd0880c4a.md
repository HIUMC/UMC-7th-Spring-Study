# ìƒí’ˆ ìˆ˜ì •

```java
@GetMapping("/items/{itemId}/edit")
public String updateItemForm(@PathVariable("itemId") Long itemId, Model model) {
    Book item = (Book) itemService.findOne(itemId); // ì˜ˆì œ ë‹¨ìˆœí™” ìœ„í•œ ë‹¤ìš´ ìºìŠ¤íŒ…(ì¶”ì²œX)

    BookForm form = new BookForm();
    form.setId(item.getId());
    form.setName(item.getName());
    form.setPrice(item.getPrice());
    form.setStockQuantity(item.getStockQuantity());
    form.setAuthor(item.getAuthor());
    form.setIsbn(item.getIsbn());

    model.addAttribute("form", form);
    return "items/updateItemForm";
}

@PostMapping("/items/{itemId}/edit")
public String updateItem(@PathVariable Long itemId, @ModelAttribute("form") BookForm form) {

    Book book = new Book();
    book.setId(form.getId());
    book.setName(form.getName());
    book.setPrice(form.getPrice());
    book.setStockQuantity(form.getStockQuantity());
    book.setAuthor(form.getAuthor());
    book.setIsbn(form.getIsbn());

    itemService.saveItem(book);
    return "redirect:/items";
}
```

[`@ModelAttribute(â€â€)` ì— ëŒ€í•´](%E1%84%89%E1%85%A1%E1%86%BC%E1%84%91%E1%85%AE%E1%86%B7%20%E1%84%89%E1%85%AE%E1%84%8C%E1%85%A5%E1%86%BC%20147d916bc5a880228803e13cd0880c4a/@ModelAttribute(%E2%80%9D%E2%80%9D)%20%E1%84%8B%E1%85%A6%20%E1%84%83%E1%85%A2%E1%84%92%E1%85%A2%20147d916bc5a880d090dae6d66a1c270b.md)

```html
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header" />
<body>
<div class="container">
  <div th:replace="fragments/bodyHeader :: bodyHeader"/>
  <form th:object="${form}" method="post">
    <!-- id -->
    <input type="hidden" th:field="*{id}" />
    <div class="form-group">
      <label th:for="name">ìƒí’ˆëª…</label>
      <input type="text" th:field="*{name}" class="form-control"
             placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
    </div>
    <div class="form-group">
      <label th:for="price">ê°€ê²©</label>
      <input type="number" th:field="*{price}" class="form-control"
             placeholder="ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”" />
    </div>
    <div class="form-group">
      <label th:for="stockQuantity">ìˆ˜ëŸ‰</label>
      <input type="number" th:field="*{stockQuantity}" class="form-control" placeholder="ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”" />
    </div>
    <div class="form-group">
      <label th:for="author">ì €ì</label>
      <input type="text" th:field="*{author}" class="form-control"
             placeholder="ì €ìë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
    </div>
    <div class="form-group">
      <label th:for="isbn">ISBN</label>
      <input type="text" th:field="*{isbn}" class="form-control"
             placeholder="ISBNì„ ì…ë ¥í•˜ì„¸ìš”" />
    </div>
    <button type="submit" class="btn btn-primary">Submit</button>
  </form>
  <div th:replace="fragments/footer :: footer" />
</div> <!-- /container -->
</body>
</html>

```

# ë³€ê²½ ê°ì§€ì™€ ë³‘í•©(merge)

---

- `saveItem()`ì„ íƒ€ê³ ê°€ë³´ì.

### ì»¨íŠ¸ë¡¤ëŸ¬

```java
@PostMapping("/items/{itemId}/edit")
public String updateItem(@PathVariable Long itemId, @ModelAttribute("form") BookForm form) {

    Book book = new Book();
    book.setName(form.getName());
    book.setPrice(form.getPrice());
    book.setStockQuantity(form.getStockQuantity());
    book.setAuthor(form.getAuthor());
    book.setIsbn(form.getIsbn());

    itemService.saveItem(book);
    return "redirect:/items";
}
```

### ì„œë¹„ìŠ¤

```java
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class ItemService {

    private final ItemRepository itemRepository;

    @Transactional
    public void saveItem(Item item) {
        itemRepository.save(item);
    }

   ...
}
```

### ë¦¬í¬ì§€í† ë¦¬

```java
@Repository
@RequiredArgsConstructor
public class ItemRepository {

    private final EntityManager em;

    public void save(Item item) {
        if (item.getId() == null) {
            em.persist(item);
        } else {
            em.merge(item);
        }
    }

    ...
}
```

- ì´ë¯¸ ìˆëŠ” itemì— ëŒ€í•œ ìˆ˜ì •ì´ê¸° ë•Œë¬¸ì—, ìµœì¢…ì ìœ¼ë¡œ `merge()`ê°€ ì¼ì–´ë‚¨ì„ ì•Œ ìˆ˜ ìˆë‹¤.
- `merge()`ëŠ” ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë³€ê²½í•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤.

# ì¤€ì˜ì† ìƒíƒœë€?

- í•œë•Œ ì˜ì† ìƒíƒœì˜€ìœ¼ë‚˜, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë”ì´ìƒ ê´€ë¦¬ë˜ì§€ ì•ŠëŠ” ìƒíƒœ
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ì œê±°í•˜ë©´ ì—”í‹°í‹°ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì™€ì˜ ì—°ê´€ì„ ìƒê³  ì¤€ì˜ì† ìƒíƒœê°€ ëœë‹¤.
    - `detatch()`, `clear()`, `close()` ì™€ ê°™ì€ ë©”ì„œë“œë¥¼ í†µí•´ ì—”í‹°í‹°ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¶„ë¦¬ë˜ë©´ ì¤€ì˜ì† ìƒíƒœë¡œ ì „í™˜ëœë‹¤.

## ì„ì˜ë¡œ ìƒì„±ëœ ê°ì²´ë¥¼ ì¤€ì˜ì† ìƒíƒœë¡œ ë³´ëŠ” ê²½ìš°

---

<aside>
ğŸ”¥

ì•„ë˜ì™€ ê°™ì€ ë¡œì§ì´ ìˆë‹¤ê³  í•˜ì.

```java
// ë¹„ì˜ì† ìƒíƒœ
Member member = new Member();
member.setId(1L);

// ì˜ì† ìƒíƒœë¡œ ì „í™˜
entityManager.merge(member); // JPAê°€ ì¤€ì˜ì† ìƒíƒœë¡œ ê°„ì£¼.

// ì´í›„ íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜ë¨
transaction.commit();
```

- ì„ì˜ë¡œ ìƒì„±í•œ member ê°ì²´ê°€ **ì‹ë³„ìë¥¼ ê°€ì§€ë„ë¡ í•˜ë©´** ì‹¤ì œ ì¤€ì˜ì† ìƒíƒœëŠ” ì•„ë‹ˆì§€ë§Œ, ì¤€ì˜ì† ìƒíƒœë¡œ ê°„ì£¼í•  ìˆ˜ ìˆë‹¤!
- ë”°ë¼ì„œ `merge()` ë©”ì„œë“œê°€ ìœ íš¨í•œ ê²ƒ
    - `merge()`ëŠ” ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë³€ê²½í•˜ëŠ” ê¸°ëŠ¥!
</aside>

# ë³€ê²½ ê°ì§€ ê¸°ëŠ¥ ì‚¬ìš©

---

```java
@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
public class ItemService {

		private final ItemRepository itemRepository;

    @Transactional
    public void updateItem(Long itemId, Book param) {
        Item findItem = itemRepository.findOne(itemId);
        findItem.setPrice(param.getPrice());
        findItem.setName(param.getName());
        findItem.setStockQuantity(param.getStockQuantity());
        
        /* â“ ë­”ê°€ ë“¤ì–´ê°€ì•¼ í• ê¹Œ? */
    }
    
    ...
}
```

â—ì•„ë¬´ ê²ƒë„ ì•ˆí•´ë„ ëœë‹¤.

- `updateItem()` ì€ íŠ¸ëœì­ì…˜ ìœ„ì—ì„œ ì˜ì† ìƒíƒœ ì—”í‹°í‹°ì˜ ê°’ì„ ë³€ê²½í•˜ê³  ìˆë‹¤.
- íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— JPAì˜ ë³€ê²½ ê°ì§€(Dirty Checking)ê°€ ì¼ì–´ë‚˜ì„œ ë³€ê²½ëœ ë‚´ìš©ì„ ìë™ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜í•œë‹¤.

# `merge()`, ë³‘í•©

---

![image.png](%E1%84%89%E1%85%A1%E1%86%BC%E1%84%91%E1%85%AE%E1%86%B7%20%E1%84%89%E1%85%AE%E1%84%8C%E1%85%A5%E1%86%BC%20147d916bc5a880228803e13cd0880c4a/image.png)

- ìœ„ ì½”ë“œì™€ ë¹„êµí•´ì„œ, ë³‘í•© ì´í›„ ë°˜í™˜ê¹Œì§€ë„ í¬í•¨í•˜ë©´ `merge()`ì˜ ë™ì‘ ê³¼ì •ê³¼ ì™„ì „íˆ ë˜‘ê°™ë‹¤.

```java
 @Transactional
    public Itme updateItem(Long itemId, Book param) {
        Item findItem = itemRepository.findOne(itemId);
        findItem.setPrice(param.getPrice());
        findItem.setName(param.getName());
        findItem.setStockQuantity(param.getStockQuantity());
        
        return findItem;
	}
```

ë”°ë¼ì„œ

ì°¸ê³ ) ë¡œì§ ì¶”ê°€ë¥¼ ìœ„í•´ ê¸°ì¡´ `save()` ë©”ì„œë“œì—ì„œ mergeë¥¼ `Item mergeItem = em.merge(item);` ë¡œ ë°”ê¿”ì„œ ì¶”ê°€í•´ë‚˜ê°€ë©´

```java
    public void save(Item item) {
        if (item.getId() == null) {
            em.persist(item);
        } else {
            Item mergeItem = em.merge(item);
            /* mergeItemì„ ì‚¬ìš©í•˜ëŠ” ë¡œì§ ì¶”ê°€ */
        }
    }
```

- `Item mergeItem = em.merge(item);` ì—ì„œ
    - parameterì—ì„œ ë„˜ê¸´ itemì€ ì¤€ì˜ì† ìƒíƒœì´ê³ 
    - mergeItemì´ ì˜ì† ìƒíƒœì´ë‹¤.
    
    â†’ êµ¬ë¶„ í•„ìš” !! : ë¡œì§ ì¶”ê°€í•´ì„œ ì“°ë ¤ë©´ mergeItemì„ ì¨ì•¼í•¨ ì£¼ì˜
    

## ì£¼ì˜ì 

ë³€ê²½ ê°ì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ì›í•˜ëŠ” ì†ì„±ë§Œ ì„ íƒí•´ì„œ ë³€ê²½í•  ìˆ˜ ìˆì§€ë§Œ, ë³‘í•©ì„ ì‚¬ìš©í•˜ë©´ ëª¨ë“  ì†ì„±ì´ ë³€ê²½ëœë‹¤. ë³‘í•© ì‹œ **ê°’ì´ ì—†ìœ¼ë©´ nullë¡œ ì—…ë°ì´íŠ¸í•  ìœ„í—˜**ë„ ìˆë‹¤.

<aside>
âš ï¸

ë³‘í•©ì€ ëª¨ë“  í•„ë“œë¥¼ êµì²´í•œë‹¤ â—â—

</aside>

# ê°€ì¥ ì¢‹ì€ í•´ê²° ë°©ë²•

### â­ ì—”í‹°í‹°ë¥¼ ë³€ê²½í•  ë•ŒëŠ” í•­ìƒ ë³€ê²½ ê°ì§€ë¥¼ ì‚¬ìš©í•˜ì!

- ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì–´ì„¤í”„ê²Œ ì—”í‹°í‹°ë¥¼ ìƒì„±í•˜ì§€ ë§ê¸°
    - ìˆ˜ì • ì½”ë“œ
        
        ```java
        @PostMapping("/items/{itemId}/edit")
        public String updateItem(@PathVariable Long itemId, @ModelAttribute("form") BookForm form) {
        
            itemService.updateItem(itemId, form);
            
            return "redirect:/items";
        }
        ```
        
- íŠ¸ëœì­ì…˜ì´ ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì— **ì‹ë³„ì(id)**ì™€ ë³€ê²½í•  ë°ì´í„° (íŒŒë¼ë¯¸í„° or DTO) ë¥¼ ëª…í™•í•˜ê²Œ ì „ë‹¬í•˜ê¸°
- íŠ¸ëœì­ì…˜ì´ ìˆëŠ” **ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ** **ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ì¡°íšŒ**í•˜ê³ , ì—”í‹°í‹°ì˜ ë°ì´í„°ë¥¼ **ì§ì ‘ ë³€ê²½**í•˜ê¸°
    - íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— ë³€ê²½ ê°ì§€ê°€ ì‹¤í–‰ëœë‹¤!